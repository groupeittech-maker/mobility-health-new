name: Deploy to Hostinger VPS

on:
  workflow_dispatch:  # D√©clenchement manuel
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
      - 'docs/**'
      - '*.md'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Test SSH connection
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 30s
        command_timeout: 15s
        script: |
          echo "üîç Testing SSH connection..."
          echo "‚úÖ Connected successfully!"
          echo "üìç Server: $(hostname)"
          echo "üìÖ Date: $(date)"
          echo "üíæ Disk space:"
          df -h / | tail -1
      continue-on-error: true
    
    - name: Check SSH connectivity
      run: |
        echo "‚ÑπÔ∏è Note: If SSH connection test failed above, the deployment may still work."
        echo "The timeout could be due to firewall restrictions from GitHub Actions IPs."
        echo "If deployment fails, check:"
        echo "  1. Firewall rules on the server (allow GitHub Actions IPs)"
        echo "  2. SSH service is running and accessible"
        echo "  3. SSH keys are correctly configured in GitHub Secrets"
    
    - name: Create frontend archive
      run: |
        cd frontend-simple
        tar czf ../frontend.tar.gz .
    
    - name: Copy frontend archive to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "frontend.tar.gz"
        target: "/tmp/"
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        strip_components: 0
        overwrite: true
      continue-on-error: false
    
    - name: Create backend archives
      run: |
        echo "üì¶ Creating backend archives..."
        # Cr√©er une archive pour le dossier app (exclure __pycache__)
        tar czf app.tar.gz --exclude="__pycache__" --exclude="*.pyc" --exclude="*.pyo" --exclude=".git" app/
        # Cr√©er une archive pour le dossier alembic
        tar czf alembic.tar.gz --exclude="__pycache__" --exclude="*.pyc" --exclude=".git" alembic/
        echo "‚úÖ Backend archives created"
    
    - name: Copy backend archives to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        source: "app.tar.gz,alembic.tar.gz,docker-compose.yml,Dockerfile,requirements.txt,alembic.ini"
        target: "/tmp/"
        timeout: 300s
        command_timeout: 300s
        use_insecure_cipher: false
        strip_components: 0
        overwrite: true
      continue-on-error: false
    
    - name: Extract and deploy frontend
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 300s
        command_timeout: 300s
        script: |
          # Extraire l'archive frontend
          echo "üì¶ Extracting frontend files..."
          sudo rm -rf /var/www/mobility-health/frontend-simple/*
          sudo tar xzf /tmp/frontend.tar.gz -C /var/www/mobility-health/frontend-simple/
          sudo chown -R deployer:deployer /var/www/mobility-health/frontend-simple
          rm /tmp/frontend.tar.gz
          
          # V√©rifier que le frontend a √©t√© mis √† jour
          echo "üì¶ Checking frontend files..."
          if [ -f "/var/www/mobility-health/frontend-simple/login.html" ]; then
            echo "‚úÖ Frontend files found"
            echo "üìÖ File date: $(stat -c %y /var/www/mobility-health/frontend-simple/login.html)"
          else
            echo "‚ùå Frontend files not found!"
          fi
          
          echo "‚úÖ Frontend deployment completed!"
    
    - name: Deploy backend and restart services
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        timeout: 600s
        command_timeout: 600s
        script: |
          set -e  # Arr√™ter en cas d'erreur
          cd /var/www/mobility-health/backend
          
          # Corriger les permissions
          echo "üîß Fixing permissions..."
          sudo chown -R deployer:deployer /var/www/mobility-health/backend
          
          # Extraire les archives backend
          echo "üì¶ Extracting backend files..."
          if [ -f "/tmp/app.tar.gz" ]; then
            sudo rm -rf app
            sudo tar xzf /tmp/app.tar.gz
            sudo chown -R deployer:deployer app
            rm /tmp/app.tar.gz
            echo "‚úÖ App directory extracted"
          else
            echo "‚ùå app.tar.gz not found!"
            exit 1
          fi
          
          if [ -f "/tmp/alembic.tar.gz" ]; then
            sudo rm -rf alembic
            sudo tar xzf /tmp/alembic.tar.gz
            sudo chown -R deployer:deployer alembic
            rm /tmp/alembic.tar.gz
            echo "‚úÖ Alembic directory extracted"
          else
            echo "‚ùå alembic.tar.gz not found!"
            exit 1
          fi
          
          # Copier les fichiers individuels
          if [ -f "/tmp/docker-compose.yml" ]; then
            sudo cp /tmp/docker-compose.yml .
            sudo chown deployer:deployer docker-compose.yml
            rm /tmp/docker-compose.yml
            echo "‚úÖ docker-compose.yml copied"
          fi
          
          if [ -f "/tmp/Dockerfile" ]; then
            sudo cp /tmp/Dockerfile .
            sudo chown deployer:deployer Dockerfile
            rm /tmp/Dockerfile
            echo "‚úÖ Dockerfile copied"
          fi
          
          if [ -f "/tmp/requirements.txt" ]; then
            sudo cp /tmp/requirements.txt .
            sudo chown deployer:deployer requirements.txt
            rm /tmp/requirements.txt
            echo "‚úÖ requirements.txt copied"
          fi
          
          if [ -f "/tmp/alembic.ini" ]; then
            sudo cp /tmp/alembic.ini .
            sudo chown deployer:deployer alembic.ini
            rm /tmp/alembic.ini
            echo "‚úÖ alembic.ini copied"
          fi
          
          # [1/6] Reconstruire les images Docker
          echo "[1/6] üî® Rebuilding Docker images..."
          if sudo docker compose build --no-cache api; then
            echo "‚úÖ Image API rebuilt successfully"
          else
            echo "‚ùå Failed to rebuild API image"
            exit 1
          fi
          
          # [2/6] Arr√™ter les services existants et lib√©rer les ports
          echo "[2/6] üõë Stopping existing services..."
          sudo docker compose down --remove-orphans || true
          
          # Lib√©rer les ports utilis√©s par les conteneurs orphelins
          echo "üîß Freeing up ports..."
          sudo docker ps -a --filter "name=mobility_health" --format "{{.ID}}" | xargs -r sudo docker rm -f || true
          
          # V√©rifier et lib√©rer le port 9000 si n√©cessaire
          if sudo lsof -ti:9000 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è Port 9000 is in use, freeing it..."
            sudo lsof -ti:9000 | xargs -r sudo kill -9 || true
            sleep 2
          fi
          
          echo "‚úÖ Services stopped and ports freed"
          
          # [3/6] D√©marrer tous les services
          echo "[3/6] üöÄ Starting all services (db, redis, minio, api, celery)..."
          if sudo docker compose up -d; then
            echo "‚úÖ Services started"
          else
            echo "‚ùå Failed to start services"
            exit 1
          fi
          
          # [4/6] Attendre que les services soient pr√™ts et v√©rifier leur √©tat
          echo "[4/6] ‚è≥ Waiting for services to be ready..."
          sleep 20
          
          # V√©rifier l'√©tat de tous les services
          echo "üîç Checking all services status..."
          sudo docker compose ps
          
          # V√©rifier que la base de donn√©es est accessible
          echo "üîç Checking database connection..."
          DB_CHECK=$(sudo docker compose exec -T db pg_isready -U postgres 2>&1 || echo "DB not ready")
          echo "Database check: $DB_CHECK"
          
          # V√©rifier que l'API est en cours d'ex√©cution
          echo "üîç Checking API container..."
          if sudo docker compose ps api | grep -q "Up\|running"; then
            echo "‚úÖ API container is running"
          else
            echo "‚ö†Ô∏è API container may not be running, waiting 10 more seconds..."
            sleep 10
            sudo docker compose ps api
          fi
          
          # [5/6] Ex√©cuter les migrations Alembic avec v√©rification stricte
          echo "[5/6] üìä Running database migrations..."
          echo "üìã Current migration status:"
          sudo docker compose exec -T api alembic current 2>&1 || echo "Could not get current migration status"
          
          echo "üìã Running migrations..."
          MIGRATION_RESULT=$(sudo docker compose exec -T api alembic upgrade head 2>&1)
          MIGRATION_EXIT_CODE=$?
          
          echo "üìã Migration output:"
          echo "$MIGRATION_RESULT"
          
          if [ $MIGRATION_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Migrations Alembic applied successfully"
            echo "üìã Final migration status:"
            sudo docker compose exec -T api alembic current 2>&1 || true
          else
            echo "‚ùå Failed to apply Alembic migrations (exit code: $MIGRATION_EXIT_CODE)"
            echo "üìã Checking API logs for errors:"
            sudo docker compose logs api --tail 50 || true
            echo "üìã Checking database connection:"
            sudo docker compose exec -T db psql -U postgres -c "SELECT version();" 2>&1 || true
            exit 1
          fi
          
          # [6/6] Red√©marrer l'API
          echo "[6/6] üîÑ Restarting API..."
          if sudo docker compose restart api; then
            echo "‚úÖ API restarted"
          else
            echo "‚ùå Failed to restart API"
            exit 1
          fi
          
          # V√©rifier le statut des services
          echo "üìä Checking service status..."
          sudo docker compose ps
          
          # V√©rifier que tous les services sont en cours d'ex√©cution
          SERVICES_STATUS=$(sudo docker compose ps --format json)
          if echo "$SERVICES_STATUS" | grep -q '"State":"running"'; then
            echo "‚úÖ All services are running"
          else
            echo "‚ö†Ô∏è Some services may not be running properly"
            sudo docker compose ps
          fi
          
          # Red√©marrer Nginx pour vider le cache
          echo "üîÑ Reloading Nginx..."
          if sudo systemctl reload nginx; then
            echo "‚úÖ Nginx reloaded"
          else
            echo "‚ö†Ô∏è Failed to reload Nginx"
          fi
          
          # Tester l'API avec plusieurs tentatives
          echo "üß™ Testing API health..."
          sleep 15
          MAX_RETRIES=3
          RETRY_COUNT=0
          API_HEALTHY=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$API_HEALTHY" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if curl -f -s https://srv1324425.hstgr.cloud/health > /dev/null 2>&1; then
              API_HEALTHY=true
              echo "‚úÖ API health check passed (attempt $RETRY_COUNT/$MAX_RETRIES)"
              curl -s https://srv1324425.hstgr.cloud/health | head -n 5
            else
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è API health check failed (attempt $RETRY_COUNT/$MAX_RETRIES), retrying in 5 seconds..."
                sleep 5
              else
                echo "‚ùå API health check failed after $MAX_RETRIES attempts"
                echo "Check logs with: sudo docker compose logs api"
                exit 1
              fi
            fi
          done
          
          echo "‚úÖ Backend deployment completed successfully!"
